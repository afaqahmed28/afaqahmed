# app.py
import streamlit as st
import pandas as pd
import numpy as np
import altair as alt

# --------------------------
# Mix Data
# --------------------------
data_1 = {
    "Revolutions": [0, 3400, 6800, 10300, 13800, 17400, 21000, 28700],
    "90.5 - 128 mm": [35.5, 28.2, 25.1, 24.9, 24.7, 22.6, 20.2, 18.6],
    "64.0 - 90.5 mm": [46.2, 53.3, 53.5, 51.9, 50.6, 49.6, 51.7, 49.0],
    "45.3 - 64.0 mm": [51.8, 48.2, 47.6, 46.1, 45.6, 45.4, 43.7, 41.8],
    "32.0 - 45.3 mm": [40.2, 38.7, 37.5, 37.0, 35.0, 33.8, 31.8, 29.0],
    "22.6 - 32.0 mm": [41.4, 39.5, 38.4, 36.7, 35.3, 34.1, 32.7, 30.3],
    "16.0 - 22.6 mm": [37.2, 35.5, 33.9, 33.1, 31.4, 29.6, 28.4, 26.1],
    "11.2 - 16.0 mm": [35.8, 33.9, 32.3, 30.2, 29.1, 28.2, 26.7, 24.2],
    "8.00 - 11.2 mm": [27.2, 25.4, 23.4, 22.0, 20.5, 19.1, 17.8, 15.8],
    "5.66 - 8.00 mm": [26.7, 24.0, 22.1, 20.1, 18.4, 16.7, 15.4, 13.0],
    "4.00 - 5.66 mm": [20.6, 17.5, 15.1, 13.5, 12.3, 10.2, 9.5, 7.5],
    "2.83 - 4.00 mm": [21.4, 17.2, 14.5, 12.0, 10.6, 9.2, 8.2, 6.5],
    "2.00 - 2.83 mm": [15.9, 11.5, 9.1, 7.1, 6.0, 5.1, 4.5, 3.3],
}

data_2 = {
    "Revolutions": [0, 10600, 21800, 42000, 71500],
    "90.5 - 128 mm": [3.8, 2.7, 2.6, 2.6, 2.5],
    "64.0 - 90.5 mm": [20.7, 21.4, 20.9, 20.1, 17.0],
    "45.3 - 64.0 mm": [55.3, 50.7, 48.3, 41.9, 37.2],
    "32.0 - 45.3 mm": [56.6, 53.0, 49.7, 46.7, 43.8],
    "22.6 - 32.0 mm": [60.7, 56.1, 52.4, 48.0, 42.0],
    "16.0 - 22.6 mm": [57.6, 54.1, 51.1, 46.8, 41.4],
    "11.2 - 16.0 mm": [55.1, 50.5, 47.5, 43.8, 39.7],
    "8.00 - 11.2 mm": [34.8, 33.1, 31.7, 29.4, 26.7],
    "5.66 - 8.00 mm": [26.9, 25.4, 23.5, 21.7, 19.9],
    "4.00 - 5.66 mm": [14.5, 13.7, 13.3, 12.0, 10.6],
    "2.83 - 4.00 mm": [9.9, 9.8, 9.7, 9.1, 8.1],
    "2.00 - 2.83 mm": [3.4, 3.5, 3.1, 3.0, 3.1],
}

data_3 = {
    "Revolutions": [0, 3700, 7400, 11100, 14900, 23000, 39000, 61000],
    "90.5 - 128 mm": [23.1, 22.8, 20.8, 19.0, 18.9, 18.7, 18.2, 16.3],
    "64.0 - 90.5 mm": [41.6, 41.256, 41.316, 41.7, 40.5, 40.0, 35.3, 29.8],
    "45.3 - 64.0 mm": [66.0, 62.9, 60.5, 58.9, 58.6, 54.4, 51.4, 48.3],
    "32.0 - 45.3 mm": [61.9, 59.4, 57.8, 57.1, 54.5, 51.2, 46.5, 40.5],
    "22.6 - 32.0 mm": [61.8, 59.0, 58.6, 56.0, 54.4, 51.5, 46.1, 41.4],
    "16.0 - 22.6 mm": [51.5, 49.9, 48.1, 47.4, 46.1, 43.4, 38.8, 34.3],
    "11.2 - 16.0 mm": [46.2, 44.2, 43.3, 41.9, 41.0, 38.7, 35.4, 31.1],
    "8.00 - 11.2 mm": [21.1, 20.9, 20.5, 20.3, 19.9, 19.5, 18.1, 16.3],
    "5.66 - 8.00 mm": [12.0, 11.6, 11.3, 11.0, 10.7, 10.3, 9.6, 8.8],
    "4.00 - 5.66 mm": [6.6, 6.3, 6.0, 5.7, 5.3, 5.1, 4.5, 3.8],
    "2.83 - 4.00 mm": [5.5, 4.8, 4.6, 4.3, 4.0, 3.6, 3.1, 2.5],
    "2.00 - 2.83 mm": [2.9, 2.3, 2.0, 1.8, 1.7, 1.4, 1.2, 1.0],
}

data_4 = {
    "Revolutions": [0, 3600, 7200, 10900, 14600, 22600, 40400, 63300],
    "90.5 - 128 mm": [21.1, 20.9, 20.7, 18.3, 18.2, 17.7, 13.5, 9.8],
    "64.0 - 90.5 mm": [41.8, 40.9, 39.3, 41.0, 39.7, 37.1, 38.5, 37.0],
    "45.3 - 64.0 mm": [60.7, 56.1, 55.5, 52.7, 51.8, 49.4, 44.8, 40.2],
    "32.0 - 45.3 mm": [68.2, 66.4, 63.7, 62.8, 61.1, 58.7, 52.1, 45.7],
    "22.6 - 32.0 mm": [68.3, 65.9, 64.9, 63.3, 62.0, 58.5, 52.1, 46.3],
    "16.0 - 22.6 mm": [49.8, 48.7, 47.2, 46.2, 45.2, 43.5, 40.2, 35.9],
    "11.2 - 16.0 mm": [38.3, 37.0, 36.1, 35.6, 35.0, 34.0, 31.0, 28.8],
    "8.00 - 11.2 mm": [20.8, 20.3, 19.8, 19.4, 18.9, 18.1, 16.8, 15.1],
    "5.66 - 8.00 mm": [13.7, 13.5, 13.2, 12.8, 12.5, 12.0, 11.0, 9.9],
    "4.00 - 5.66 mm": [6.8, 6.3, 6.2, 5.9, 5.7, 5.3, 4.6, 4.0],
    "2.83 - 4.00 mm": [6.6, 5.7, 5.3, 5.0, 4.6, 4.1, 3.4, 2.7],
    "2.00 - 2.83 mm": [4.7, 3.7, 3.2, 2.8, 2.5, 2.1, 1.4, 1.1],
}

data_5 = {
    "Revolutions": [0, 710, 2340, 6600, 12600],
    "90.5 - 128 mm": [27.4, 25.6, 23.5, 21.6, 19.5],
    "64.0 - 90.5 mm": [54.0, 52.9, 50.0, 40.9, 36.2],
    "45.3 - 64.0 mm": [46.4, 42.4, 40.9, 39.7, 36.1],
    "32.0 - 45.3 mm": [40.3, 38.5, 35.4, 33.3, 31.3],
    "22.6 - 32.0 mm": [38.8, 36.8, 34.8, 31.8, 27.6],
    "16.0 - 22.6 mm": [38.7, 36.0, 33.9, 30.1, 26.7],
    "11.2 - 16.0 mm": [38.4, 35.3, 32.2, 28.9, 25.7],
    "8.00 - 11.2 mm": [32.9, 29.9, 27.6, 23.2, 19.9],
    "5.66 - 8.00 mm": [32.1, 28.5, 25.6, 21.9, 18.1],
    "4.00 - 5.66 mm": [21.9, 19.0, 16.9, 13.5, 11.0],
    "2.83 - 4.00 mm": [22.8, 19.2, 17.1, 13.6, 10.2],
    "2.00 - 2.83 mm": [15.6, 14.0, 11.8, 9.1, 6.4],
}

data_6 = {
    "Revolutions": [0, 13000, 23000, 33500],
    "90.5 - 128 mm": [11.7, 10.9, 8.8, 8.6],
    "64.0 - 90.5 mm": [47.6, 32.0, 29.4, 27.5],
    "45.3 - 64.0 mm": [94.7, 73.4, 63.5, 60.1],
    "32.0 - 45.3 mm": [83.0, 70.3, 65.5, 62.8],
    "22.6 - 32.0 mm": [66.0, 54.3, 50.4, 48.8],
    "16.0 - 22.6 mm": [41.3, 33.9, 31.6, 30.5],
    "11.2 - 16.0 mm": [27.7, 21.1, 19.6, 19.1],
    "8.00 - 11.2 mm": [14.0, 8.8, 8.3, 8.4],
    "5.66 - 8.00 mm": [10.0, 3.9, 3.8, 3.7],
    "4.00 - 5.66 mm": [5.0, 1.2, 1.2, 1.1],
    "2.83 - 4.00 mm": [3.8, 0.5, 0.5, 0.5],
    "2.00 - 2.83 mm": [2.0, 0.2, 0.1, 0.1],
}

data_7 = {
    "Revolutions": [0, 10000, 18500, 27500],
    "90.5 - 128 mm": [11.7, 11.4, 9.9, 9.5],
    "64.0 - 90.5 mm": [47.6, 41.3, 42.3, 36.3],
    "45.3 - 64.0 mm": [94.7, 80.0, 71.1, 60.8],
    "32.0 - 45.3 mm": [83.0, 75.3, 74.6, 64.3],
    "22.6 - 32.0 mm": [66.0, 58.8, 49.7, 50.5],
    "16.0 - 22.6 mm": [41.3, 38.4, 36.3, 32.6],
    "11.2 - 16.0 mm": [27.7, 25.0, 22.4, 20.8],
    "8.00 - 11.2 mm": [14.0, 12.3, 11.9, 8.5],
    "5.66 - 8.00 mm": [10.0, 7.6, 7.3, 4.0],
    "4.00 - 5.66 mm": [5.0, 3.1, 2.9, 1.3],
    "2.83 - 4.00 mm": [3.8, 1.9, 1.7, 0.6],
    "2.00 - 2.83 mm": [2.0, 0.7, 0.6, 0.2],
}

data_8 = {
    "Revolutions": [0, 12000, 22000, 30500],
    "90.5 - 128 mm": [11.7, 10.9, 10.9, 9.1],
    "64.0 - 90.5 mm": [47.6, 44.0, 37.6, 34.0],
    "45.3 - 64.0 mm": [94.7, 84.3, 74.3, 63.4],
    "32.0 - 45.3 mm": [83.0, 77.9, 69.0, 59.4],
    "22.6 - 32.0 mm": [66.0, 61.5, 57.5, 50.9],
    "16.0 - 22.6 mm": [41.3, 40.2, 37.2, 32.6],
    "11.2 - 16.0 mm": [27.7, 26.1, 23.4, 19.3],
    "8.00 - 11.2 mm": [14.0, 13.5, 11.8, 8.7],
    "5.66 - 8.00 mm": [10.0, 9.1, 7.2, 4.2],
    "4.00 - 5.66 mm": [5.0, 4.2, 3.1, 1.4],
    "2.83 - 4.00 mm": [3.8, 2.8, 1.7, 0.6],
    "2.00 - 2.83 mm": [2.0, 1.2, 0.7, 0.3],
}

# --------------------------
# Mix Dictionary & Size Order
# --------------------------
mixes = {
    1: data_1, 2: data_2, 3: data_3, 4: data_4,
    5: data_5, 6: data_6, 7: data_7, 8: data_8
}

SIZE_ORDER = [
    "90.5 - 128 mm","64.0 - 90.5 mm","45.3 - 64.0 mm","32.0 - 45.3 mm",
    "22.6 - 32.0 mm","16.0 - 22.6 mm","11.2 - 16.0 mm","8.00 - 11.2 mm",
    "5.66 - 8.00 mm","4.00 - 5.66 mm","2.83 - 4.00 mm","2.00 - 2.83 mm"
]

# ------------------------------
# FUNCTIONS
# ------------------------------

def interpolate_mass_loss(mix_data, size, revolutions):
    """Interpolate mass loss from the dataset for a given size and revolutions."""
    rev = np.array(mix_data["Revolutions"])
    mass_loss = np.array(mix_data[size])
    return np.interp(revolutions, rev, mass_loss)

def compute_abrasion_coefficient(mass_loss, initial_mass, net_power, revolutions, rpm):
    """
    Compute abrasion coefficient per joule (or per unit energy)
    Energy = Power x Time
    """
    time_seconds = revolutions / rpm * 60  # Revolutions / revs per minute -> minutes -> seconds
    energy_joules = net_power * time_seconds
    return (mass_loss / initial_mass) / energy_joules

# ------------------------------
# STREAMLIT APP
# ------------------------------

st.title("Particle Abrasion Coefficient Calculator")

# Mix selection
mix_id = st.selectbox("Select Mix", list(mixes.keys()))
mix_data = mixes[mix_id]

st.write("Available particle sizes:", SIZE_ORDER)

# Input multiple sizes
selected_sizes = st.multiselect("Select Particle Sizes", SIZE_ORDER, default=[SIZE_ORDER[0]])

# Input initial mass per size
mass_inputs = {}
for s in selected_sizes:
    mass_inputs[s] = st.number_input(f"Initial Mass for size {s} (kg)", min_value=0.0, value=10.0)

# Revolutions, Net Power, RPM
revolutions = st.number_input("Number of Revolutions", min_value=0, value=1000)
net_power = st.number_input("Net Power (W)", min_value=0.0, value=500.0)
rpm = st.number_input("RPM of Mill", min_value=1.0, value=30.0)

for size in [c for c in df.columns if c != "Revolutions"]:
    m = df[size].to_numpy(float)
    m0 = float(m[0])
    m_final = float(m[-1])
    observed_mass_loss = m0 - m_final  # observed mass loss

    # 1) Fit directly in ENERGY domain: ln(m/m0) = - a_E * E
    a_E, R2_E, nE = fit_forced_origin(E, m, use_prefix=True)

    # 2) Reference: fit in REV domain + convert
    a_rev, R2_rev, nR = fit_forced_origin(rev, m, use_prefix=True)
    a_km  = a_rev * (1000.0 / dist_per_rev_m)
    a_dkm = a_km / 3.0
    a_E_conv = a_rev / ( (E[1]-E[0]) / (rev[1]-rev[0]) ) if (rev.size>1 and (rev[1]-rev[0])!=0) else np.nan

    rows.append({
        "Mix": mix_id,
        "Size interval (mm)": size,
        "m0": m0,
        "Observed Mass Loss": observed_mass_loss,
        "Total Mass Loss": m0 - m_final,  # total mass lost for clarity
        # ENERGY-domain fit (primary)
        "a_E [1/J]": a_E,
        "a_kJ [1/kJ]": a_E * 1e3,
        "a_MJ [1/MJ]": a_E * 1e6,
        "R2 (energy fit)": R2_E,
        "n_used (energy)": nE,
        # for reference (distance/rev domain too)
        "a_rev [1/rev]": a_rev,
        "a_km [1/km]": a_km,
        "a_d_km [1/km/diam]": a_dkm,
        "R2 (rev fit)": R2_rev,
        "a_E (from a_rev) [1/J]": a_E_conv,
    })








